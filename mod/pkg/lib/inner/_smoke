# shellcheck    shell=dash
___x_cmd_pkg__smoke() (
    local bin_mod_name="${1:?Provide a candidate name}"
    local candidate; candidate="$(___x_cmd_pkg___get_binmod_name "$bin_mod_name")"
    local version="${2:-$(___x_cmd_pkg_default_version "$candidate")}"

    pkg:info "Smoke testing bin_mod_name => $bin_mod_name candidate => $candidate version => $version"

    pkg:debug "Checking the active version of $candidate"
    if ! x env try "$candidate"="$version"; then
        pkg:error "Smoke FAIL. Failed to set $candidate=$version"
        return 1
    fi

    pkg:debug "Checking the install path of $candidate $version"
    local bin_path; bin_path="$(command -v "$bin_mod_name")"
    if [ "${bin_path#"$___X_CMD_PKG_INSTALL_PATH/$candidate/$version/"}" = "$bin_path" ]; then
        pkg:error "Smoke FAIL. Install path of $candidate $version is not $___X_CMD_PKG_INSTALL_PATH/$candidate/$version/, current path => $bin_path"
        return 1
    fi

    pkg:debug "Checking the smoke file of $candidate $version"
    local smokepath; smokepath=$(ls "$___X_CMD_PKG_RAW_PATH"/*"/$candidate/.x-cmd/smoke.sh") 2>/dev/null
    if ! [ -f "$smokepath" ]; then
        pkg:warn "Smoke file of $candidate doesn't exist, smokepath => $smokepath"
        return 1
    fi

    pkg:debug "Checking the smoke of $candidate $version"
    if ! . "$smokepath"; then
        pkg:error "Smoke FAIL. Smoke file returned exit code $candidate $version"
        return 1
    fi

    pkg:info "Smoke PASS. $candidate $version "
)
