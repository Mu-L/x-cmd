# shellcheck shell=sh disable=SC3043
# Reference: 

___x_cmd_proxy_apt(){
    param:subcmd ___x_cmd_proxy_apt \
        ls                "List all the mirrors"             \
        current           "Get current apt mirror"           \
        "replace|set"     "Replace the download mirror"      \
        "rollback"        "Rollback the download mirror"
    param:subcmd:try
    param:run

    x hascmd apt || N=proxy M="[command=apt] not found." log:ret:1
    [ "$#" -eq 0 ] || {
        ___x_cmd_proxy___util_subcmd_invalid apt "$@"
        return 1
    }

    local _SELECT
    x ui select "_SELECT" \
        "Methods:" \
            "Set apt mirror (default is ali)" \
            "Get current apt mirror" \
            "List all the apt mirror candidates" \
            "Rollback the apt mirror to the original official"
    
    case "$_SELECT" in
        1)  ___x_cmd_proxy_apt_replace       ;;
        2)  ___x_cmd_proxy_apt_current       ;;
        3)  ___x_cmd_proxy_apt_ls            ;;
        4)  ___x_cmd_proxy_apt_rollback      ;;
        *)  proxy:info "Canceled" ; return 1 ;;
    esac
}

___x_cmd_proxy_apt_ls(){
    param:void

    printf "%s\n" \
        "Code          Url                                  Name"                 \
        "ali           mirrors.aliyun.com                   阿里云镜像站"           \
        "tuna          mirrors.tuna.tsinghua.edu.cn         清华大学开源软件镜像站"  \
        "ustc          mirrors.ustc.edu.cn                  中国科学技术大学开源镜像站" \
        "bfsu          mirrors.bfsu.edu.cn                  北京外国语大学开源软件镜像站" \
        "tencent       mirrors.tencent.com                  腾讯软件源"             \
        "netease       mirrors.163.com                      网易开源镜像站"         \
        "sohu          mirrors.sohu.com                     搜狐开源镜像站"
}

___x_cmd_proxy_apt_current(){
    param:void
    ___x_cmd_cmds cat /etc/apt/sources.list
}

___x_cmd_proxy_apt___url(){
    ___x_cmd_proxy_apt_ls | \
        ___x_cmd_cmds_awk -v name="$1" 'NR>1 && $1 == name { print $2 ; exit 0;}'
}

# TODO: Just replace the original text, maybe not the best way.
# shellcheck disable=SC2120
___x_cmd_proxy_apt_replace() {
    param:dsl <<A
option:
    #1    "Mirror name"       <mirror-name>=ali    = ali tuna ustc bfsu tencent netease sohu
A
    param:run

    # TODO: Some problem in ubuntu 12.04
    local url
    if url="$(___x_cmd_proxy_apt___url "${1}")"; then
        proxy:info "Setting apt mirror $url"

        local src_path
        src_path="/etc/apt/sources.list"
        ___x_cmd_proxy___backup /etc/apt/sources.list apt

        local tmp
        tmp="$(___x_cmd_cmds_cat $src_path)"
        
        # If there is no root permission, use sudo
        if [ "$(id -u)" -ne 0 ]; then
            proxy:warn "using sudo"
            printf "%s" "$tmp" | sudo awk '!/^#/ { gsub(/:\/\/[^\/]*\//, "://'"$url"'/"); } { print }' | sudo tee "$src_path" > /dev/null
            sudo apt update
        else
            printf "%s" "$tmp" | ___x_cmd_cmds awk '!/^#/ { gsub(/:\/\/[^\/]*\//, "://'"$url"'/"); } { print }' > "$src_path"
            apt update
        fi
    fi
}

# Rollback from the last backup file.
# Get the last backup file from the backup directory.
# shellcheck disable=SC2120
___x_cmd_proxy_apt_rollback() {
    param:dsl <<A
option:
    #1          "use the selected file to rollback"
subcommand:
    ls          "list all file you can rollback"
A
    param:run

    if [ -n "$PARAM_SUBCMD" ]; then
        ___x_cmd_proxy_apt_rollback_"${PARAM_SUBCMD}" "$@"
        return
    fi

    if [ "$(id -u)" -ne 0 ]; then
        proxy:warn "using sudo"
        IS_ROOT=1 ___proxy_rollback /etc/apt/sources.list apt "$1"
    else
        ___proxy_rollback /etc/apt/sources.list apt "$1"
    fi 
}

___x_cmd_proxy_apt_rollback_ls() {
    param:void
    ___proxy_rollback_ls apt
}
