# shellcheck shell=sh disable=SC3043

# author:       Li Junhao           l@x-cmd.com    edwinjhlee.github.io
# maintainer:   Li Junhao

x log init proxy

xrc:mod:lib proxy share

___x_cmd_proxy(){
    [ "$#" -gt 0 ] ||   set -- --help

    local op="$1"; shift
    case "$op" in
        set|unset)
            ___x_cmd_proxy_"$op" "$@" ;;
        -h|--help)
            x help -m proxy "$@"
            return   ;;
    esac
}

# proxy set 127.0.0.1:7070
# proxy set 127.0.0.1:7070 ftp=ftp://127.0.0.1:7070

___x_cmd_proxy___inner_set(){
    local proxy="$2"

    case $proxy in
        https://*|http://*|socks*://*|ftp*://*)     ;;
        *)          
            proxy="http://$proxy"
            proxy:info "Considered as $proxy"
            ;;
    esac
    case "$1" in
        http)
                export http_proxy="$proxy"
                export HTTP_PROXY="$proxy"
                printf "  SET http_proxy=%s\n" "$proxy"
                printf "  SET HTTP_PROXY=%s\n" "$proxy"
                ;;
        https)
                export https_proxy="$proxy"
                export HTTPS_PROXY="$proxy"
                printf "  SET https_proxy=%s\n" "$proxy"
                printf "  SET HTTPS_PROXY=%s\n" "$proxy"
                ;;    
        ftp)
                export ftp_proxy="$proxy"
                export FTP_PROXY="$proxy"
                printf "  SET ftp_proxy=%s\n" "$proxy"
                printf "  SET FTP_PROXY=%s\n" "$proxy"
                ;;
        all)
                export all_proxy="$proxy"
                export ALL_PROXY="$proxy"
                printf "  SET all_proxy=%s\n" "$proxy"
                printf "  SET ALL_PROXY=%s\n" "$proxy"
    esac
}

___x_cmd_proxy_run(){
    local http_proxy=""
    local https_proxy=""
    local ftp_proxy=""
    local all_proxy=""
    local HTTP_PROXY=""
    local HTTPS_PROXY=""
    local FTP_PROXY=""
    local ALL_PROXY=""

    ___x_cmd_proxy_set "$@"
}

___x_cmd_proxy_set(){
    case "$1" in
        -h|--help)
            x help -m proxy set >&2; return 1 ;;
    esac

    if [ "$#" -eq 0 ]; then
        printf "Current proxy setting:\n"
        printf "  http_proxy=%s\n" "$http_proxy"
        printf "  HTTP_PROXY=%s\n" "$HTTP_PROXY"
        printf "  https_proxy=%s\n" "$http_proxy"
        printf "  HTTPS_PROXY=%s\n" "$HTTPS_PROXY"
        printf "  ftp_proxy=%s\n" "$ftp_proxy"
        printf "  FTP_PROXY=%s\n" "$FTP_PROXY"
        printf "  all_proxy=%s\n" "$all_proxy"
        printf "  ALL_PROXY=%s\n" "$ALL_PROXY"
        return
    fi

    while [ "$#" -gt 0 ]; do
        case "$1" in
            http=*)         ___x_cmd_proxy___inner_set http "${1#http=}"   ;;
            https=*)        ___x_cmd_proxy___inner_set https "${1#https=}" ;;
            ftp=*)          ___x_cmd_proxy___inner_set ftp "${1#ftp=}"     ;;
            all=*)          ___x_cmd_proxy___inner_set all "${1#all=}"     ;;

            --)             shift; break ;;
            *)              
                proxy:info "Considered as :"
                ___x_cmd_proxy___inner_set http  "http://$1"
                ___x_cmd_proxy___inner_set https "http://$1"
                ___x_cmd_proxy___inner_set ftp   "ftp://$1"
                ___x_cmd_proxy___inner_set all   "socks5://$1"
                ;;
        esac
        shift
    done

    [ $# -eq 0 ] || "$@"
}

___x_cmd_proxy_unset(){
    case "$1" in
        -h|--help)
            x help -m proxy unset >&2; return 1 ;;
    esac

    if [ "$#" -eq 0 ]; then
        ___x_cmd_proxy_unset http https ftp all
        return
    fi

    while true; do
        case "$1" in
            http)         
                printf "  UNSET http_proxy\n"
                printf "  UNSET HTTP_PROXY\n"
                export http_proxy=
                export HTTP_PROXY= ;;
            https)        
                printf "  UNSET https_proxy\n"
                printf "  UNSET HTTPS_PROXY\n"
                export https_proxy=
                export HTTPS_PROXY= ;;
            ftp)          
                printf "  UNSET ftp_proxy\n"
                printf "  UNSET FTP_PROXY\n"
                export ftp_proxy=
                export FTP_PROXY= ;;
            all)          
                printf "  UNSET all_proxy\n"
                printf "  UNSET ALL_PROXY\n"
                export all_proxy=
                export ALL_PROXY= ;;
            *)             
                break
        esac
        shift
    done
    
}
