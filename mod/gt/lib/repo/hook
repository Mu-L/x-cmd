# shellcheck shell=sh disable=SC2154,SC3043,SC2034

___x_cmd_gt_repo_hook(){
    param:scope         ___x_cmd_gt
    param:subcmd ___x_cmd_gt_repo_hook               \
        "ls|l"          "List   repo webhook"                        \
        "create|c"      "Create repo webhook"                        \
        "info|i"        "Show   repo webhook detailed information"   \
        "edit|ed"       "Edit   repo webhook configure"              \
        rm              "Remove repo webhook"                        \
        test            "Try    repo webhook url test connect"
    param:subcmd:try
    param:run

    ___x_cmd_gt_repo_hook _param_help_doc
    return 1
}

# Section: List

# https://gitee.com/api/v5/swagger#/getV5ReposOwnerRepoHooks
___x_cmd_gt_repo_hook_ls(){
    param:scope     ___x_cmd_gt
    param:dsl       '
options:
    --repo|-r           "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
    --page              "page"                                                               <>=""
    --per_page          "per_page"                                                           <>=""
    --json|-j           "output origin json data"
'
    param:run
    ___x_cmd_gt_param_init_owner_repo

    ___X_CMD_UI_STATIC=1  ___gt_ui_mutual '___ui_table_json Id=.id Url=.url ResultCode=.result_code PushEvents=.push_events TagPushEvent=.tag_push_events \
        IssuesEvent=.issues_events NoteEvent=.note_events MergeRequestEvent=.merge_requests_events -- $@' \
        ___x_cmd_gt_get_multi "/repos/${owner_repo}/hooks"

    ___x_cmd_gt_repo_hook_ls_status_handler "$@"
}

___x_cmd_gt_repo_hook_ls_status_handler(){
    if [ ! -t 1 ] || [ -n "$ENFORCE_JSON" ]; then
        ___x_cmd_gt_http_error
        return
    fi
    local _sep
    _sep=$(printf "\003")
    case "$___X_CMD_UI_TABLE_FINAL_COMMAND" in
            "ENTER")        printf "%s\n" "$___X_CMD_UI_TABLE_CUR_ROW_HEADER: $___X_CMD_UI_TABLE_CUR_ITEM"              ;;
            "c")            ___x_cmd_gt_repo_hook_add    "${owner_repo}"                                                ;;
            "u")            ___x_cmd_gt_repo_hook_edit --id "${___X_CMD_UI_TABLE_CUR_LINE%%"$_sep"*}" "${owner_repo}"   ;;
            "d")            ___x_cmd_gt_repo_hook_rm     --id "${___X_CMD_UI_TABLE_CUR_LINE%%"$_sep"*}" "${owner_repo}" ;;
            "r")            NO_CACHE=1 ___x_cmd_gt_repo_hook_ls "$@"                                                    ;;
            *)              return   ;;
    esac
}

# EndSection

# Section: Info

# https://gitee.com/api/v5/swagger#/getV5ReposOwnerRepoHooksId
___x_cmd_gt_repo_hook_info(){
    param:scope     ___x_cmd_gt
    param:dsl       '
options:
    #1                "webhooks id"                                                        <>:NatureNumber
    --repo|-r         "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
    --json|-j         "output origin json data"
'
    param:run
    [ -n "$1" ] || M='accepts 1 arg(webhooks id), received empty' arg:ret:64
    local id="$1"
    ___x_cmd_gt_param_init_owner_repo

    ___x_cmd_gt_curl get "/repos/${owner_repo}/hooks/${id}" | \
        ___x_cmd_gt_repo_hook____ui_handler Info "$id"
}

# EndSection

# Section: Create

# https://gitee.com/api/v5/swagger#/postV5ReposOwnerRepoHooks
___x_cmd_gt_repo_hook_create(){
    param:scope     ___x_cmd_gt
    param:dsl       '
type:
    HookEncryptionType =  password signkey ""
options:
    --repo|-r                   "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
    --url                       "webhooks remote url"                                                <>:Address

    --encryption_type           "encryption type"                                                    <>:HookEncryptionType=""
    --password                  "Requesting a URL with password to prevent maliciously request"      <>=""
    --no_push_events            "Turn off push code event(default is push code event)"
    --tag_push_events           "Turn on push tag event"
    --issues_events             "Turn on create|close issue event"
    --note_events               "Turn on note code|issue event"
    --merge_requests_events     "Turn on merge request|merged event"
    --json|-j                   "output origin json data"
'
    param:run
    case "$encryption_type" in
        password)          encryption_type=0                    ;;
        signkey)           encryption_type=1                    ;;
    esac
    local gen_gt_json
    gen_gt_json="$(
        param:option2json -repo  push_events=^no_push_events \
            tag_push_events=^^tag_push_events   issues_events=^^issues_events \
            note_events=^^note_events           merge_requests_events=^^merge_requests_events )"
    gt:debug "$gen_gt_json"

    ___x_cmd_gt_param_init_owner_repo
    ___x_cmd_gt_curl post "/repos/${owner_repo}/hooks" "gen_gt_json" | \
        ___x_cmd_gt_repo_hook____ui_handler Creating
}

# EndSection

# Section: Edit
# https://gitee.com/api/v5/swagger#/patchV5ReposOwnerRepoHooksId
___x_cmd_gt_repo_hook_edit(){
    param:scope     ___x_cmd_gt
    param:dsl       '
type:
    HookEncryptionType =  password signkey ""
options:
    #1                          "webhooks id"                                                        <>:NatureNumber
    --repo|-r                   "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
    --url                       "webhooks remote url"                                                <>:Address

    --encryption_type           "encryption type"                                                    <>:HookEncryptionType=""
    --password                  "Requesting a URL with password to prevent maliciously request"      <>=""
    --no_push_events            "Turn off push code event(default is push code event)"
    --tag_push_events           "Turn on push tag event"
    --issues_events             "Turn on create|close issue event"
    --note_events               "Turn on note code|issue event"
    --merge_requests_events     "Turn on merge request|merged event"
    --json|-j                   "output origin json data"
'
    param:run
    [ -n "$1" ] || M='accepts 1 arg(webhooks id), received empty' arg:ret:64
    local id="$1"
    case "$encryption_type" in
        password)          encryption_type=0                    ;;
        signkey)           encryption_type=1                    ;;
    esac
    local gen_gt_json
    gen_gt_json="$(
        param:option2json  -repo -id   push_events=^no_push_events \
            tag_push_events=^^tag_push_events   issues_events=^^issues_events \
            note_events=^^note_events           merge_requests_events=^^merge_requests_events )"
    gt:debug "$gen_gt_json"

    ___x_cmd_gt_param_init_owner_repo
    ___x_cmd_gt_curl patch "/repos/${owner_repo}/hooks/${id}" "gen_gt_json" | \
        ___x_cmd_gt_repo_hook____ui_handler Modify
}

# EndSection

# Section: Remove
# https://gitee.com/api/v5/swagger#/deleteV5ReposOwnerRepoHooksId
___x_cmd_gt_repo_hook_rm(){
    param:scope     ___x_cmd_gt
    param:dsl       '
options:
    #1                "webhooks id"                                                        <>:NatureNumber
    --repo|-r         "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
    --yes|-y          "Ignore remove prompt interception"
'
    param:run
    [ -n "$1" ] || M='accepts 1 arg(webhooks id), received empty' arg:ret:64
    ___x_cmd_gt_param_init_owner_repo

    [ "$yes" = "true" ] || ___x_cmd_ui_yesno "Are you sure to $owner_repo remove hook: $(___x_cmd_ui bold red "$id") ?" || return 1
    ___x_cmd_gt_curl del "/repos/${owner_repo}/hooks/${id}" | (
            [ -z "$___X_CMD_GT_IN_TEST_ENV" ] || { command cat; return; }
            x jo env . gt_resp_err=.message gt_resp_err=.error
            if ___x_cmd_gt_http_error; then
                ___x_cmd_ui_tf true  "Remove $id hook to repo $owner_repo successfully:"
            else
                ___x_cmd_ui_tf false "Remove $id hook to repo $owner_repo failure:" >&2
                ___x_cmd_gt____handle_resp
                return 1
            fi
        )
}

# EndSection

# Section: Test

# https://gitee.com/api/v5/swagger#/postV5ReposOwnerRepoHooksIdTests
___x_cmd_gt_repo_hook_test(){
    param:scope     ___x_cmd_gt
    param:dsl       '
options:
    #1                "webhooks id"                                                        <>:NatureNumber
    --repo|-r         "<ownerPath>/<RepoPath> (default ownerPath: current user)"           <>:RepoPath
'
    param:run
    [ -n "$1" ] || M='accepts 1 arg(webhooks id), received empty' arg:ret:64
    local id="$1"
    ___x_cmd_gt_param_init_owner_repo

    ___x_cmd_gt_curl post "/repos/${owner_repo}/hooks/${id}/tests" | (
            [ -z "$___X_CMD_GT_IN_TEST_ENV" ] || { command cat; return; }
            x jo env . gt_resp_err=.message gt_resp_err=.error
            if ___x_cmd_gt_http_error; then
                ___x_cmd_ui_tf true  "Test $id hook on repo $owner_repo successfully. Please check remote url is received:"
            else
                ___x_cmd_ui_tf false "Test $$id hook to $owner_repo failure:" >&2
                ___x_cmd_gt____handle_resp
                return 1
            fi
        )
}

# EndSection

# Section: repo hook UI
___x_cmd_gt_repo_hook____ui_handler(){
    if [ -n "$ENFORCE_JSON" ] || [ -n "$json" ]; then
        cat
        ___x_cmd_gt_http_error
        return
    fi
    (
        _data="url=.url result_code=.result_code password=.password created_at=.created_at push_events=.push_events tag_push_events=.tag_push_events issues_events=.issues_events note_events=.note_events merge_requests_events=.merge_requests_events"
        case "$1" in
            Creating|Modify)
                _inf_msg="$1 webhooks on $owner_repo successfully"
                _err_msg="$1 webhooks on $owner_repo failure"
            ;;
            Info)
                _inf_msg="$owner_repo $2 webhooks information"
                _err_msg="No find any repo webhooks data by $owner_repo $2"
            ;;
        esac
        eval x jo env . _id=.id gt_resp_err=.message gt_resp_err=.error "$_data"
        if [ -n "$_id" ]; then
            ___x_cmd_ui_tf  true "${_inf_msg}:" ${_id:+"ID: $_id"} ${result_code:+"result_code: $result_code"} ${password:+"Password: $password"} ${created_at:+"Created At: $created_at"} \
                ${push_events:+"Push Events: $push_events"} ${tag_push_events:+"Tag Push Events: $tag_push_events"} ${issues_events:+"Issues Events: $issues_events"} \
                ${note_events:+"Note Events: $note_events"} ${merge_requests_events:+"Merge Requests Events: $merge_requests_events"} ${url:+"URL: $url"}
        else
            ___x_cmd_ui_tf false "${_err_msg}:" >&2
            ___x_cmd_gt____handle_resp
            return 1
        fi
    )
}
# EndSection