# shellcheck shell=dash

___x_cmd_llmf_model_ls(){
    local scope=all
    local format=app
    while [ $# -gt 0 ]; do
        case "$1" in
            -j|--json)      format=json     ;;
            -c|--csv)       format=csv      ;;
            --app)          format=app      ;;

            --all)          scope=all       ;;
            --local)        scope=local     ;;
            *)              break ;;
        esac
        shift
    done

    if [ "$scope" = all ]; then
        ___x_cmd_llmf_model_ls___"$format" --all
    else
        ___x_cmd_llmf_model_ls___"$format" --local
    fi
}

# Section: inner
___x_cmd_llmf_model_ls___json(){
    local dir=
    case "$1" in
        --local)    dir="$___X_CMD_LLMF_MODEL_DATA_CACHE";;
        *)          dir="$___X_CMD_LLMF_MODEL_DATA_INFO" ;;
    esac
    [ -d "$dir" ] || N=llmf M="Data is empty" log:ret:1

    (
        ___x_cmd_cmds cd "$dir" || return
        ___x_cmd_cmds find . -type f 2>/dev/null | while read -r l; do
            [ "$l" = "${l%".log"}" ] || continue
            l="${l#"./"}"
            l="${l%"."*}"
            printf "%s\n" "$l"
        done
    ) | ___x_cmd_llmf_model_ls___json_inner

}

___x_cmd_llmf_model_ls___json_inner(){
    ___x_cmd_llava___prepare_metadata || return
    x cawk -v dirpath="$___X_CMD_LLMF_MODEL_DATA_INFO" -m j/json,j/jiter,j/jcp \
        -f "$___X_CMD_ROOT_MOD/llmf/lib/awk/parse_info.awk"
}

___x_cmd_llmf_model_ls___csv(){
    ___x_cmd_llmf_model_ls___json "$@" | x cawk -m j/json,j/jiter,csv -f "$___X_CMD_ROOT_MOD/llmf/lib/awk/json2csv.awk"
}

___x_cmd_llmf_model_ls___app()(
    local ___X_CMD_CSV_APP_DATA; ___X_CMD_CSV_APP_DATA="$( ___x_cmd_llmf_model_ls___csv "$@" )" || return
    [ -n "$___X_CMD_CSV_APP_DATA" ] || N=llmf M="Data is empty" log:ret:1
    x csv app --return var --clear || return
    [ -n "$___X_CMD_CSV_APP_DATA_name" ] || return
    local selected="${___X_CMD_CSV_APP_DATA_name}/${___X_CMD_CSV_APP_DATA_version}/${___X_CMD_CSV_APP_DATA_quant}.${___X_CMD_CSV_APP_DATA_format}"
    printf "%s\n" "$selected"
)

# EndSection
