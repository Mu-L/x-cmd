
# Using chatgpt api
# ref: https://platform.openai.com/docs/api-reference/chat/create

# --maxtoken --proxy --apikey

___x_cmd_openai_request(){
    local message;  local apikey;   local proxy;    local maxtoken=1000;    # default maxtoken 1000
    ___x_cmd_openai_cur apikey:= proxy:= maxtoken:=     # Default value

    while [ $# -gt 0 ]; do
        case "$1" in
            --apikey)       apikey="$2";    [ $# -ge 2 ] || N=openai M="Please provide apikey value"   log:ret:64; shift 2 ;;
            --proxy)        proxy="$2";     [ $# -ge 2 ] || N=openai M="Please provide proxy value"    log:ret:64; shift 2 ;;
            --message)      message="$2";   [ $# -ge 2 ] || N=openai M="Please provide message value"  log:ret:64; shift 2 ;;
            --maxtoken)     maxtoken="$2";  [ $# -ge 2 ] || N=openai M="Please provide maxtoken value" log:ret:64; shift 2 ;;
            *)              break;
        esac
    done

    [ -n "$apikey" ] || {
        openai:error "Please setting up your apikey first ==> 'x chat cfg apikey=<your apikey>' or 'x chat apikey=<your apikey>'"
        return 1
    }

    local data='{
        "model": "gpt-3.5-turbo",
        "messages": '"$message"',
        "temperature": 0.7,
        "max_tokens": '$maxtoken',
        "stream": true
    }'

    openai:debug "data ==> $data"

    # TODO: Need to json quote the content
    # LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
    x curl \
        ${proxy:+-x} ${proxy:+"$proxy"}                 \
        -sS https://api.openai.com/v1/chat/completions  \
        -H "Content-Type: application/json"             \
        -H "Authorization: Bearer $apikey"              \
        -d "$data" # | tee result.json
}
