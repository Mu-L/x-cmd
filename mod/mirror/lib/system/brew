# shellcheck shell=sh disable=SC3043

# Cannot works well because of this
# https://e.gitee.com/lteam18/issues/list?is%5Bsearch%5D=mirror&issue=I3YXC0

# Reference: https://brew.idayer.com/guide/change-source/
# Reference: https://zhuanlan.zhihu.com/p/90508170

___x_cmd_mirror_brew(){
    [ "$#" -gt 0 ] || { ___x_cmd_mirror_brew___app ; return ; }

    local op="$1"; shift
    case "$op" in
        -h|--help)
            x help -m mirror brew "$@"
            return   ;;
    esac

    x hascmd brew || N=mirror M="[command=brew] not found." log:ret:1
    case "$op" in
        ls|set|current|unset)
                ___x_cmd_mirror_brew_"${op}"               "$@" ;;
        *)      ___x_cmd_mirror___util_subcmd_invalid brew "$@" ;;
    esac
}

___x_cmd_mirror_brew___app(){
    local _SELECT
    x ui select "_SELECT" \
        "Methods:" \
            "Set brew mirror (default is tuna)" \
            "List all the brew mirror candidates" \
            "Get current brew mirror" \
            "Reset the brew mirror to the original official"

    case "$_SELECT" in
        1)  ___x_cmd_mirror_brew_set       ;;
        2)  ___x_cmd_mirror_brew_ls        ;;
        3)  ___x_cmd_mirror_brew_current   ;;
        4)  ___x_cmd_mirror_brew_unset     ;;
        *)  mirror:info "Canceled" ; return 1 ;;
    esac

}

___x_cmd_mirror_brew_ls(){
    printf "%s\n" \
        "Code          Url                                   Name"                    \
        "bfsu          https://mirrors.bfsu.edu.cn           北京外国语大学开源软件镜像站" \
        "tuna          https://mirrors.tuna.tsinghua.edu.cn  清华大学开源软件镜像站"      \
        "ustc          https://mirrors.ustc.edu.cn           中国科学技术大学开源镜像站"   \
        "tencent       http://mirrors.cloud.tencent.com      腾讯软件源"                \
        "ali           https://mirrors.aliyun.com/homebrew   阿里云镜像站"
}

___x_cmd_mirror_brew___url(){
    ___x_cmd_mirror_brew_ls | \
        ___x_cmd_mirror___util_get_url_by_name "$1"
}

___x_cmd_mirror_brew_current(){
    printf "%s\n" \
        "HOMEBREW_API_DOMAIN=$HOMEBREW_API_DOMAIN" \
        "HOMEBREW_BOTTLE_DOMAIN=$HOMEBREW_BOTTLE_DOMAIN" \
        "HOMEBREW_BREW_GIT_REMOTE=$HOMEBREW_BREW_GIT_REMOTE" \
        "HOMEBREW_CORE_GIT_REMOTE=$HOMEBREW_CORE_GIT_REMOTE" \
        "GIT_DIR=$(git -C "$(brew --repo)" config --get remote.origin.url)"
}

# shellcheck disable=SC2120
___x_cmd_mirror_brew_set(){
    [ "$#" -gt 0 ] ||   set -- bfsu
    case "$1" in
        -h|--help)
            x help -m mirror brew replace "$@"
            return   ;;
    esac

    if [ "$1" = "official" ] ; then
        ___x_cmd_mirror_brew_unset
        return
    fi

    local url
    url="$(___x_cmd_mirror_brew___url "${1}")" || return 1
    mirror:info "Setting brew mirror $url"

    export HOMEBREW_API_DOMAIN="$url/homebrew-bottles/api"
    export HOMEBREW_BOTTLE_DOMAIN="$url/homebrew-bottles"
    export HOMEBREW_BREW_GIT_REMOTE="$url/git/homebrew/brew.git"
    export HOMEBREW_CORE_GIT_REMOTE="$url/git/homebrew/homebrew-core.git"

    mirror:info "Add HOMEBREW_API_DOMAIN HOME_BOTTLE_DOMAIN HOMEBREW_BREW_GIT_REMOTE HOMEBREW_CORE_GIT_REMOTE to boot rc"

    x boot rc add homebrew-api-domain "export HOMEBREW_API_DOMAIN=$HOMEBREW_API_DOMAIN"
    x boot rc add homebrew-bottle-domain "export HOMEBREW_BOTTLE_DOMAIN=$HOMEBREW_BOTTLE_DOMAIN"
    x boot rc add homebrew-brew-git-remote "export HOMEBREW_BREW_GIT_REMOTE=$HOMEBREW_BREW_GIT_REMOTE"
    x boot rc add homebrew-core-git-remote "export HOMEBREW_CORE_GIT_REMOTE=$HOMEBREW_CORE_GIT_REMOTE"

    mirror:info "Now brew update"
    brew update --verbose
}

___x_cmd_mirror_brew_unset(){
    mirror:info "Reset the brew mirror to the original official"
    unset HOMEBREW_BOTTLE_DOMAIN
    unset HOMEBREW_API_DOMAIN
    unset HOMEBREW_BREW_GIT_REMOTE
    unset HOMEBREW_CORE_GIT_REMOTE

    mirror:info "Remove HOMEBREW_API_DOMAIN HOME_BOTTLE_DOMAIN HOMEBREW_BREW_GIT_REMOTE HOMEBREW_CORE_GIT_REMOTE from boot rc"

    x boot rc del homebrew-bottle-domain
    x boot rc del homebrew-api-domain
    x boot rc del homebrew-brew-git-remote
    x boot rc del homebrew-core-git-remote

    # brew 程序本身，Homebrew / Linuxbrew 相同
    git -C "$(brew --repo)" remote set-url origin https://github.com/Homebrew/brew

    # 以下针对 Linux 系统上的 Linuxbrew
    mirror:info "Now brew reset origin tap"
    unset HOMEBREW_API_DOMAIN
    unset HOMEBREW_CORE_GIT_REMOTE

    # reference: https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/
    if x os is darwin ; then
        local BREW_TAPS
        BREW_TAPS="$(brew tap 2>/dev/null | tr '\n' ':')"
        for tap in core cask-fonts cask-versions command-not-found services; do
            if printf "%s" "$BREW_TAPS" | grep -q ":homebrew/${tap}:"; then
                brew tap --custom-remote "homebrew/${tap}" "https://github.com/Homebrew/homebrew-${tap}"
            fi
        done


    elif x os is linux ; then
        brew tap --custom-remote homebrew/core https://github.com/Homebrew/homebrew-core
        brew tap --custom-remote homebrew/command-not-found https://github.com/Homebrew/homebrew-command-not-found
        brew tap --custom-remote homebrew/services https://github.com/Homebrew/homebrew-services
    else
        mirror:warn "Unknown os"
    fi


    mirror:info "Now brew update"
    brew update --verbose
}
