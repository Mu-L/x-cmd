# shellcheck shell=dash
___x_cmd_hn_user(){
    local X_help_cmd="x help -m hn user"; help:arg-null:parse
    ourl:arg:format:all
    local user="$1";    [ -n "$user" ] ||   N=user M="Please provide the user name" log:ret:64

    ___x_cmd_hn_user___"$format" "$@"
}

___x_cmd_hn_user___app(){
    local x_
    x fifo consumer_ ___x_cmd_hn_user___parse_json2app
    ___x_cmd_hn_user___json "$@" >"$x_"
}

___x_cmd_hn_user___csv(){
    local x_
    x fifo consumer_ ___x_cmd_hn_user___parse_json2csv
    ___x_cmd_hn_user___json "$@" >"$x_"
}

___x_cmd_hn_user___tsv(){
    local x_
    x fifo consumer_ ___x_cmd_hn_user___parse_json2tsv
    ___x_cmd_hn_user___json "$@" >"$x_"
}

___x_cmd_hn_user___json(){
    # while [ $# -gt 0 ]; do
    #     ___x_cmd_hn_user___raw "$1" | ___x_cmd_hn_user___parse_resp2json 1 || return
    #     shift
    # done
    ___x_cmd_hn_user___raw "$@" | ___x_cmd_hn_user___parse_resp2json "$#"
}

___x_cmd_hn_user___raw(){
    local IFS=","
    local userlist="{$*}"

    local temp; temp="$___X_CMD_ROOT_TMP/hn/user/$(x rand uuid)..."
    x mkdirp "$temp"

    set -- "https://hacker-news.firebaseio.com/v0/user/$userlist.json?print=pretty" --fail-early --fail-with-body
    set -- "$@" -m 3 -L -sS -w "$___X_CMD_OURL_WRITEOUT" --output "${temp}#1"

    x curl "$@" 2>&1
}

# Section
___x_cmd_hn_user___parse_resp2json(){
    local n=$1
    ourl:writeout:init
    while ourl:writeout:read; do
        n="$((n-1))"
        case "$XOW_code" in
            20*)    ___x_cmd_cmds cat ;;
            *)      hn:error "[Http_code=$XOW_code] Get data failed"
                    ___x_cmd_ourl_json2errorlog ;  return "$XOW_exitcode"
        esac <"${XOW_fp}"
        x rmrf "$XOW_fp"
    done
    [ "${n}" -le 0 ]
}

___x_cmd_hn_user___parse_json2csv(){
    printf "%s\n" "id,created,karma,about,submitted"
    x ja jl2c .id .created .karma .about .submitted
}

___x_cmd_hn_user___parse_json2tsv(){
    ___x_cmd_hn_user___parse_json2csv | x csv 2tsv
}

___x_cmd_hn_user___parse_json2app(){
    x yml j2y | x yq
}
# EndSection
